
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pytools.api._alltracker &#8212; pytools  documentation</title>
<script>
  document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
  document.documentElement.dataset.theme = localStorage.getItem("theme") || "light"
</script>

  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=92025949c220c2e29695" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=92025949c220c2e29695" rel="stylesheet">


  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/gamma.css" />

  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/gamma.js"></script>
    <script src="../../../_static/js/versions.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="docsearch:language" content="None">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="light">
    <div class="bd-header-announcement container-fluid" id="banner">
      

    </div>

    
    <nav class="bd-header navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="bd-header__inner container-xl">

  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
    <img src="../../../_static/gamma_pytools_logo.png" class="logo__image only-light" alt="Logo image">
    <img src="../../../_static/gamma_pytools_logo.png" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="fas fa-bars"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../_generated/getting_started.html">
  Getting started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../apidoc/pytools.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../contribution_guide.html">
  Development Guidelines
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../faqs.html">
  FAQ
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../_generated/release_notes.html">
  Release Notes
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="bd-container container-xl">
      <div class="bd-container__inner row">
          

<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="bd-sidebar-primary col-12 col-md-3 bd-sidebar">
  <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
  </div>
  <div class="sidebar-end-items">
  </div>
</div>


          


<div class="bd-sidebar-secondary d-none d-xl-block col-xl-2 bd-toc">
  
</div>


          
          
          <div class="bd-content col-12 col-md-9 col-xl-7">
              
              <article class="bd-article" role="main">
                
  <h1>Source code for pytools.api._alltracker</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Core implementation of :mod:`pytools.api`.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">FunctionType</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">get_type_hints</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;AllTracker&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public_module_prefix&quot;</span><span class="p">,</span>
    <span class="s2">&quot;update_forward_references&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="c1">#</span>
<span class="c1"># Type variables</span>
<span class="c1">#</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
<span class="n">T_Collection</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T_Collection&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Collection</span><span class="p">)</span>
<span class="n">T_Callable</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T_Callable&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Callable</span><span class="p">)</span>
<span class="n">T_Iterable</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T_Iterable&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Iterable</span><span class="p">)</span>
<span class="n">T_Type</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T_Type&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># The AllTracker, used to check that __all__ includes all publicly defined symbols</span>
<span class="c1">#</span>


<div class="viewcode-block" id="AllTracker"><a class="viewcode-back" href="../../../apidoc/pytools/api/pytools.api.AllTracker.html#pytools.api.AllTracker">[docs]</a><span class="k">class</span> <span class="nc">AllTracker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Track global, public items defined in a module and validate that all eligible items</span>
<span class="sd">    have been included in the ``__all__`` variable.</span>

<span class="sd">    Items will be tracked if:</span>

<span class="sd">    - their name does not start with an underscore character</span>
<span class="sd">    - they are defined after the :class:`.AllTracker` instance has been created</span>

<span class="sd">    The underlying idea (and widely used pattern in GAMMA packages) is to define all</span>
<span class="sd">    items in one or more private submodules, export all public items using the</span>
<span class="sd">    ``__all__`` keyword, and import them into a public package one level up</span>
<span class="sd">    (usually the package&#39;s ``__init__.py``).</span>

<span class="sd">    This ensures a clean namespace in the public package, uncluttered by any imports</span>
<span class="sd">    used in the private module.</span>

<span class="sd">    The tracker also performs additional checks to validate the eligibility of</span>
<span class="sd">    definitions for being exported:</span>

<span class="sd">    - constant definitions should not be exported, as this will pose difficulties</span>
<span class="sd">      with Sphinx documentation and - from an API design perspective - provides less</span>
<span class="sd">      context than defining constants inside classes</span>
<span class="sd">    - definitions exported from other modules should not be re-exported by the importing</span>
<span class="sd">      module</span>

<span class="sd">    These validation checks can be overridden if required in special cases.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: if ``True``, automatically replace all forward</span>
    <span class="c1">#: type references in function annotations with the referenced classes;</span>
    <span class="c1">#: see :func:`.update_forward_references`</span>
    <span class="n">update_forward_references</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="c1">#: if ``True``, allow exporting public global constants in ``__all__``;</span>
    <span class="c1">#: these typically have no ``__module__`` or ``__doc__`` attributes and will</span>
    <span class="c1">#: not be properly rendered in generated documentation</span>
    <span class="n">allow_global_constants</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="c1">#: if ``True``, allow exporting definitions in ``__all__`` even if they have been</span>
    <span class="c1">#: imported from another module</span>
    <span class="n">allow_imported_definitions</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="c1"># noinspection PyShadowingNames</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">globals_</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">public_module</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">update_forward_references</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">allow_global_constants</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">allow_imported_definitions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param globals_: the dictionary of global variables obtained by calling</span>
<span class="sd">            :meth:`.globals` in the current module scope</span>
<span class="sd">        :param public_module: full name of the public module that will export the items</span>
<span class="sd">            managed by this tracker</span>
<span class="sd">        :param update_forward_references: if ``True``, automatically replace all forward</span>
<span class="sd">            type references in function annotations with the referenced classes; see</span>
<span class="sd">            :func:`.update_forward_references`</span>
<span class="sd">            (default: ``True``)</span>
<span class="sd">        :param allow_global_constants: if ``True``, allow exporting public global</span>
<span class="sd">            constants in ``__all__``;</span>
<span class="sd">            these typically have no ``__module__`` or ``__doc__`` attributes and will</span>
<span class="sd">            not be properly rendered in generated documentation (default: ``False``)</span>
<span class="sd">        :param allow_imported_definitions: if ``True``, allow exporting definitions in</span>
<span class="sd">            ``__all__`` even if they have been imported from another module</span>
<span class="sd">            (default: ``False``)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_globals</span> <span class="o">=</span> <span class="n">globals_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imported</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">globals_</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="n">module</span> <span class="o">=</span> <span class="n">globals_</span><span class="p">[</span><span class="s2">&quot;__name__&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;arg globals_ does not define module name in __name__&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">public_module</span><span class="p">:</span>
            <span class="n">public_module</span> <span class="o">=</span> <span class="n">public_module_prefix</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">public_module</span> <span class="o">=</span> <span class="n">globals_</span><span class="p">[</span><span class="s2">&quot;__publicmodule__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">public_module</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_forward_references</span> <span class="o">=</span> <span class="n">update_forward_references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_global_constants</span> <span class="o">=</span> <span class="n">allow_global_constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_imported_definitions</span> <span class="o">=</span> <span class="n">allow_imported_definitions</span>

    <span class="c1">#: Full name of the public module that will export the items managed by this</span>
    <span class="c1">#: tracker.</span>
    <span class="n">public_module</span><span class="p">:</span> <span class="nb">str</span>

<div class="viewcode-block" id="AllTracker.validate"><a class="viewcode-back" href="../../../apidoc/pytools/api/pytools.api.AllTracker.html#pytools.api.AllTracker.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate that all eligible items that were defined since the creation of this</span>
<span class="sd">        tracker are listed in the ``__all__`` variable.</span>

<span class="sd">        :raise AssertionError: if ``__all__`` is not as expected, or if one or more</span>
<span class="sd">            definitions do not meet the required criteria to be exported (</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tracked</span><span class="p">()</span>

        <span class="n">globals_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globals</span>

        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">globals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__all__&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_expected</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="s2">&quot;missing or unexpected all declaration, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;expected:</span><span class="se">\n</span><span class="s2">__all__ = </span><span class="si">{</span><span class="n">all_expected</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span>
        <span class="n">public_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">public_module</span>
        <span class="n">allow_global_constants</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_global_constants</span>
        <span class="n">forbid_imported_definitions</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_imported_definitions</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">all_expected</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">globals_</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="c1"># check that the object was defined locally</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj_module</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">allow_global_constants</span><span class="p">:</span>
                    <span class="n">obj_module</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;exporting a global constant is not permitted: </span><span class="si">{</span><span class="n">obj</span><span class="si">!r}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">forbid_imported_definitions</span> <span class="ow">and</span> <span class="n">obj_module</span> <span class="ow">and</span> <span class="n">obj_module</span> <span class="o">!=</span> <span class="n">module</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_qualname</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="si">}</span><span class="s2"> is exported by module </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;but defined in module </span><span class="si">{</span><span class="n">obj_module</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># set public module field</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">__publicmodule__</span> <span class="o">=</span> <span class="n">public_module</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c1"># objects without a __dict__ will not permit setting the public module</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_forward_references</span><span class="p">:</span>
                <span class="c1"># update forward references in annotations</span>
                <span class="n">update_forward_references</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">globals_</span><span class="o">=</span><span class="n">globals_</span><span class="p">)</span></div>

<div class="viewcode-block" id="AllTracker.get_tracked"><a class="viewcode-back" href="../../../apidoc/pytools/api/pytools.api.AllTracker.html#pytools.api.AllTracker.get_tracked">[docs]</a>    <span class="k">def</span> <span class="nf">get_tracked</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List the names of all locally tracked, public items.</span>

<span class="sd">        :return: the list of object names, sorted alphabetically</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_eligible</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globals</span><span class="p">))</span></div>

<div class="viewcode-block" id="AllTracker.is_tracked"><a class="viewcode-back" href="../../../apidoc/pytools/api/pytools.api.AllTracker.html#pytools.api.AllTracker.is_tracked">[docs]</a>    <span class="k">def</span> <span class="nf">is_tracked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the given item is tracked by this tracker under the given name.</span>

<span class="sd">        :param name: the name of the item in the tracker&#39;s global namespace</span>
<span class="sd">        :param item: the item referred to by the name</span>
<span class="sd">        :return: ``True`` if the given item is tracked by this tracker under the given</span>
<span class="sd">            name; ``False`` otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="n">item</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_eligible</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">_is_eligible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># check if the given item is eligible for tracking by this tracker</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imported</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="c1"># get a tracked item by name</span>

        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_eligible</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">item</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>


<span class="c1"># regular expression to extract the public prefix of a private module</span>
<span class="c1"># this is the module path up to the first submodule with a leading underscore</span>
<span class="c1"># noinspection RegExpUnnecessaryNonCapturingGroup</span>
<span class="n">__RE_PUBLIC_MODULE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="c1"># start of match group for the public part of the module path</span>
    <span class="sa">r</span><span class="s2">&quot;(&quot;</span>
    <span class="c1"># first module component must not start with &#39;_&#39;)</span>
    <span class="sa">r</span><span class="s2">&quot;(?:[a-zA-Z]\w+)&quot;</span>
    <span class="c1"># then as many path components as can be matched non-greedily …)</span>
    <span class="sa">r</span><span class="s2">&quot;(?:\.\w+)*?&quot;</span>
    <span class="c1"># but when we hit the first private path component, we stop matching the</span>
    <span class="c1"># public part of the path …</span>
    <span class="sa">r</span><span class="s2">&quot;)&quot;</span>
    <span class="c1"># … and match the rest as the private path</span>
    <span class="sa">r</span><span class="s2">&quot;(?:\._\w*(?:\.\w+)*)?&quot;</span>
<span class="p">)</span>


<div class="viewcode-block" id="public_module_prefix"><a class="viewcode-back" href="../../../apidoc/pytools/api/pytools.api.public_module_prefix.html#pytools.api.public_module_prefix">[docs]</a><span class="k">def</span> <span class="nf">public_module_prefix</span><span class="p">(</span><span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the public prefix of the given module name.</span>

<span class="sd">    A module name is composed of one or more identifiers, separated by ``.`` operators.</span>
<span class="sd">    The public prefix is the module name including all identifiers up to, and excluding,</span>
<span class="sd">    the first identifier starting with an underscore character (``_``) .</span>
<span class="sd">    If there is no such identifier, then the public prefix is the same as the full</span>
<span class="sd">    module name.</span>
<span class="sd">    If the first identifier starts with a ``_``, then the public prefix is not defined.</span>

<span class="sd">    For example:</span>

<span class="sd">    - the public module prefix of ``a.b._c.d._e`` is ``a.b``</span>
<span class="sd">    - the public module prefix of ``a.b`` is ``a.b``</span>
<span class="sd">    - the public module prefix of ``_a.b.c`` is undefined</span>

<span class="sd">    :param module_name: the module name for which to get the public prefix</span>
<span class="sd">    :return: the public prefix</span>
<span class="sd">    :raise ValueError: the public prefix is undefined</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">__RE_PUBLIC_MODULE</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cannot infer public module path from module </span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>


<span class="c1">#</span>
<span class="c1"># Ensure all symbols introduced below are included in __all__</span>
<span class="c1">#</span>

<span class="n">__tracker</span> <span class="o">=</span> <span class="n">AllTracker</span><span class="p">(</span><span class="nb">globals</span><span class="p">())</span>
<span class="c1"># we forget that class AllTracker itself is already defined, because we want to include</span>
<span class="c1"># it in the __all__ statement</span>
<span class="c1"># noinspection PyProtectedMember</span>
<span class="n">__tracker</span><span class="o">.</span><span class="n">_imported</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">AllTracker</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<span class="c1"># noinspection PyProtectedMember</span>
<span class="n">__tracker</span><span class="o">.</span><span class="n">_imported</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">public_module_prefix</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="update_forward_references"><a class="viewcode-back" href="../../../apidoc/pytools/api/pytools.api.update_forward_references.html#pytools.api.update_forward_references">[docs]</a><span class="k">def</span> <span class="nf">update_forward_references</span><span class="p">(</span>
    <span class="n">obj</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">type</span><span class="p">,</span> <span class="n">FunctionType</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">globals_</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace all forward references with their referenced classes.</span>

<span class="sd">    :param obj: a function or class</span>
<span class="sd">    :param globals_: a global namespace to search the referenced classes in</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">my_module</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="c1"># the object cannot be a type or function; no action required</span>
        <span class="k">return</span>

    <span class="c1"># keep track of classes we already visited to prevent infinite recursion</span>
    <span class="n">visited</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="n">_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">local_ns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_obj</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="n">my_module</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">_obj</span><span class="p">)</span>
                <span class="n">local_ns</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="n">_obj</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">_update</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">local_ns</span><span class="o">=</span><span class="n">local_ns</span><span class="p">)</span>
                <span class="n">_update_annotations</span><span class="p">(</span><span class="n">_obj</span><span class="p">,</span> <span class="n">local_ns</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_obj</span><span class="p">,</span> <span class="n">FunctionType</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_obj</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="n">my_module</span><span class="p">:</span>
            <span class="n">_update_annotations</span><span class="p">(</span><span class="n">_obj</span><span class="p">,</span> <span class="n">local_ns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_annotations</span><span class="p">(</span><span class="n">_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">local_ns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]):</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="n">get_type_hints</span><span class="p">(</span>
            <span class="n">_obj</span><span class="p">,</span> <span class="n">globalns</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">_obj</span><span class="p">,</span> <span class="s2">&quot;__globals__&quot;</span><span class="p">,</span> <span class="n">globals_</span><span class="p">),</span> <span class="n">localns</span><span class="o">=</span><span class="n">local_ns</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">annotations</span><span class="p">:</span>
            <span class="n">_obj</span><span class="o">.</span><span class="vm">__annotations__</span> <span class="o">=</span> <span class="n">annotations</span>

    <span class="n">_update</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>


<span class="n">__tracker</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>


<span class="c1">#</span>
<span class="c1"># Auxiliary functions</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_qualname</span><span class="p">(</span><span class="n">_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_obj</span><span class="o">.</span><span class="vm">__qualname__</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_obj</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">_obj</span><span class="p">)</span>
</pre></div>

              </article>
              

              
              <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              </footer>
              
          </div>
          
      </div>
    </div>

  
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695"></script>

<footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    <p class="copyright">
    &copy; Copyright 2022, Boston Consulting Group (BCG).<br>
</p>
  </div>
  
  <div class="footer-item">
    <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
  </div>
  
</div>
</footer>
  </body>
</html>